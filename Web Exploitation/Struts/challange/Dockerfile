FROM ubuntu:16.04
RUN sed -i 's/archive.ubuntu.com/mirrors.edge.kernel.org/g' /etc/apt/sources.list && \
 apt-get update && \
 apt-get install -y --no-install-recommends \
 openjdk-8-jdk \
 maven \
 wget \
 unzip \
 xmlstarlet \
 && apt-get clean \
 && rm -rf /var/lib/apt/lists/*
RUN wget https://archive.apache.org/dist/tomcat/tomcat-8/v8.5.13/bin/apache-tomcat-8.5.13.tar.gz && \
 tar -xzf apache-tomcat-8.5.13.tar.gz -C /opt && \
 rm apache-tomcat-8.5.13.tar.gz
WORKDIR /app
COPY pom.xml /app/
COPY src/ /app/src/
RUN echo "Spark{B0ou3radaFTW!!_23qd45sq6}" > /opt/flag.txt && \
 chmod 400 /opt/flag.txt
RUN mvn package
RUN cp target/*.war /opt/apache-tomcat-8.5.13/webapps/product-catalog.war

# Modify server.xml to change port to 4010
RUN xmlstarlet ed -u "/Server/Service/Connector[@protocol='HTTP/1.1']/@port" -v "4010" /opt/apache-tomcat-8.5.13/conf/server.xml > /tmp/server.xml && \
 mv /tmp/server.xml /opt/apache-tomcat-8.5.13/conf/server.xml

EXPOSE 4010
CMD ["/opt/apache-tomcat-8.5.13/bin/catalina.sh", "run"]
