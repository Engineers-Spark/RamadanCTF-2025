FROM ubuntu:latest

# Install necessary dependencies
RUN apt-get update && apt-get install -y \
    gcc \
    make \
    vim \
    sudo \
    iputils-ping \
    libc6-dev \
    python3 \
    python3-pip\
    python3-venv\
    tmux\
    openssh-server\
    && rm -rf /var/lib/apt/lists/*

# Add users with specific privileges
RUN useradd -m player && \
    useradd -m pwn_me && \
    echo "pwn_me:m#hXl4.vp&xXBS0G{tlv#2]XcH({dn&SM;Q6" | chpasswd && \
    echo "player:player" | chpasswd

# Create a flag for pwn_me
RUN echo "Spark{_u_r_faster_than_cats??_i_doubt_it!!__1a3a3430479aecfbac2}" > /home/pwn_me/flag.txt && \
    chown pwn_me:pwn_me /home/pwn_me/flag.txt

# Set home directories for both users
RUN mkdir -p /home/player && \
    mkdir -p /home/pwn_me

# Give pwn_me sudo rights for the /home/pwn_me directory
RUN echo "player ALL=(pwn_me) NOPASSWD: /home/pwn_me/super_hyper_meow" >> /etc/sudoers

# Create a C binary that interacts with shared memory

WORKDIR /usr/local/bin
COPY cats.c .
RUN gcc cats.c -o cats
RUN chmod 555 cats 


WORKDIR /home/pwn_me
COPY super_hyper_meow.c .
RUN chmod u-w flag.txt
RUN chmod u-w .bashrc

RUN gcc super_hyper_meow.c -o super_hyper_meow

RUN chown pwn_me:pwn_me /home/pwn_me/super_hyper_meow && \
    chmod u+s /home/pwn_me/super_hyper_meow


#pip_stuff

RUN mkdir /home/player/.cache
RUN chmod u+w /home/player/.cache

#SSH
RUN mkdir /var/run/sshd
RUN echo "AllowUsers player" >> /etc/ssh/sshd_config
RUN ssh-keygen -A # <-- Generates missing SSH host keys
RUN service ssh start

RUN sed -i 's/PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config


RUN echo "PasswordAuthentication yes" >> /etc/ssh/sshd_config



WORKDIR /home/player
USER root
RUN chown -R root:player /home/player
COPY super_hyper_meow.c .
RUN chmod 444 super_hyper_meow.c
RUN echo "alias tmux='tmux -u'" >> .bashrc
RUN chmod u-w .bash_logout
RUN chmod u-w .bashrc




RUN ssh-keygen -t ed25519 -f ~/.ssh/id_ed25519 # <-- creating sshkey 



RUN chsh -s /bin/bash player

#RUN source /home/player/.bashrc
EXPOSE 22
CMD ["/usr/sbin/sshd","-D"]
